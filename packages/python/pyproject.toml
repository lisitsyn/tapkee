[build-system]
requires = ["scikit-build-core>=0.10", "nanobind>=2.0"]
build-backend = "scikit_build_core.build"

[project]
name = "tapkee"
version = "1.3"
description = "C++ library for dimensionality reduction"
readme = "README.md"
requires-python = ">=3.11"
license = "BSD-3-Clause"
authors = [
    { name = "Sergey Lisitsyn", email = "lisitsyn@hey.com" },
    { name = "Fernando Jos√©", email = "fernando.iglesiasg@gmail.com" },
]
dependencies = ["numpy"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Science/Research",
    "Programming Language :: C++",
    "Programming Language :: Python :: 3",
    "Topic :: Scientific/Engineering",
]

[project.urls]
Homepage = "https://tapkee.lisitsyn.me"
Repository = "https://github.com/lisitsyn/tapkee"
Issues = "https://github.com/lisitsyn/tapkee/issues"

[tool.scikit-build]
cmake.source-dir = "../.."
cmake.args = ["-DBUILD_NANOBIND=ON", "-DBUILD_CLI=OFF"]
wheel.packages = []
wheel.install-dir = "."
install.components = ["python"]

[tool.cibuildwheel]
build = ["cp311-*", "cp312-*", "cp313-*", "cp314-*"]
skip = ["*-musllinux*", "*-win32", "*_i686", "cp*t-*"]
test-requires = ["numpy"]
test-command = '''python -c "import tapkee; import numpy as np; r = tapkee.embed(np.random.randn(3, 50), method='pca'); assert r.shape == (50, 2)"'''

[tool.cibuildwheel.linux]
manylinux-x86_64-image = "manylinux_2_28"
manylinux-aarch64-image = "manylinux_2_28"
before-all = [
    "dnf install -y epel-release",
    "dnf install -y arpack-devel cmake",
    "curl -L https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2 | tar xj -C /tmp",
    "cmake -S /tmp/eigen-3.4.0 -B /tmp/eigen-build -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_TESTING=OFF",
    "cmake --install /tmp/eigen-build",
    "curl -L https://github.com/fmtlib/fmt/archive/refs/tags/10.2.1.tar.gz | tar xz -C /tmp",
    "cmake -S /tmp/fmt-10.2.1 -B /tmp/fmt-build -DCMAKE_INSTALL_PREFIX=/usr/local -DFMT_TEST=OFF",
    "cmake --build /tmp/fmt-build",
    "cmake --install /tmp/fmt-build",
]

[tool.cibuildwheel.macos]
before-all = "brew install eigen arpack fmt"

[tool.cibuildwheel.windows]
before-all = "vcpkg install eigen3 arpack-ng fmt --triplet x64-windows"
before-build = "pip install delvewheel"
repair-wheel-command = "delvewheel repair -w {dest_dir} {wheel} --add-path C:/vcpkg/installed/x64-windows/bin"
environment = { CMAKE_ARGS="-DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake" }

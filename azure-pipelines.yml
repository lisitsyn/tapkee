jobs:
  - job: macosx
    pool:
      vmImage: 'macOS-latest'
    steps:
      - script: |
          brew update
          brew install arpack eigen googletest
        displayName: 'Install dependencies'
      - task: CMake@1
        displayName: 'Setup with CMake'
        inputs:
          cmakeArgs: -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON ..
      - script: make
        displayName: 'Build with Make'
        workingDirectory: build
      - script: ctest --output-on-failure
        displayName: 'Test'
        workingDirectory: build
      - task: PublishBuildArtifacts@1
        displayName: 'Publish'
        inputs:
          pathtoPublish: 'bin'
          artifactName: latest-macosx
  - job: ubuntu
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - script: |
          sudo apt-get install -y libeigen3-dev libarpack2-dev libgtest-dev
      - task: CMake@1
        displayName: 'Setup with CMake'
        inputs:
          cmakeArgs: -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON ..
      - script: make
        displayName: 'Build with Make'
        workingDirectory: build
      - script: ctest --output-on-failure
        displayName: 'Test'
        workingDirectory: build
      - task: PublishBuildArtifacts@1
        displayName: 'Publish'
        inputs:
          pathtoPublish: 'bin'
          artifactName: latest-ubuntu
  - job: windows
    pool:
      vmImage: 'windows-latest'
    steps:
      - task: CondaEnvironment@1
        displayName: Install dependencies
        inputs:
          createCustomEnvironment: True
          environmentName: tapkee
          packageSpecs: 'python=3.11.* eigen gtest'
          createOptions: '-c conda-forge'
          updateConda: false
      - task: CMake@1
        displayName: 'Setup with CMake'
        inputs:
          cmakeArgs: -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON -DCMAKE_PREFIX_PATH=$(CONDA_PREFIX)\Library ..
      - script: cmake --build . --config Debug
        displayName: 'Build with CMake'
        workingDirectory: build
      - script: ctest --output-on-failure -C Debug
        displayName: 'Test'
        workingDirectory: build
      - task: PublishBuildArtifacts@1
        displayName: 'Publish'
        inputs:
          pathtoPublish: 'bin'
          artifactName: latest-windows
